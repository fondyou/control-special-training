# 第一节：51单片机外部中断

**本节知识点:**

- 外部中断相关的寄存器分析
- 外部中断编程说明 

## 一、外部中断是什么？

- 外部中断即通过外部电平或上下降沿触发所产生的中断。

- 51单片机的外部中断源有两个，分别为INT0和INT1，分别由引脚INT0（P3.2）和INT1（P3.3）输入，中断源请求方式有两种：低电平触发和下降沿触发。

	- 选择电平触发时，单片机在每个机器周期检查中断源口线，检测到低电平，即置位中断请求标志，向CPU请求中断。
	- 选择边沿触发方式时，单片机在上一个机器周期检测到中断源口线为高电平，下一个机器周期检测到低电平，即置位中断标志，请求中断。

- 外部中断引脚


## 二、外部中断相关的寄存器

> 外部中断主要设置3个寄存器参数EA、EX、IT，这些寄存器分别属于IE和TCON;

- EA为总中断开关，1 为打开，0 为关闭；
- EX为外部中断允许寄存器，1 为允许，0 为关闭；
- IT为外部中断触发方式选择寄存器，1 为边沿触发，0 为电平触发；

- 外部中断触发方式选择位：ITx（x:代表0,1）。
  - ITx=0时，外部中断x触发方式为低电平触发，在这种方式下，CPU在每个机器周期检测外部中断请求输入引脚电平，若检测为低电平，则硬件将置位相应中断标志位IEx，响应请求后通过硬件清零IEx。
  - ITx=1时，外部中断x触发方式为下降沿触发，在这种方式。下，CPU在连续的两个机器周期先后检测到先高电平后低电平，则将置位相应中断标志位IEx，响应请求后通过硬件清零IEx。

- 外部中断允许位EXx：
  - EXx=0：禁止外部中断x。
  - EXx=0：允许外部中断x。

## 三、外部中断的注意点

- 1) 电平触发方式时，中断标志寄存器不锁存中断请求信号。

  - 单片机把每个机器周期的采样到的外部中断源口线的电平逻辑直接赋值到中断标志寄存器。标志寄存器对于请求信号来说是透明的。这样当中断请求被阻塞而没有得到及时响应时，将被丢失。换句话说，要使电平触发的中断被CPU响应并执行，必须保证外部中断源口线的低电平维持到中断被执行为止。因此当CPU正在执行同级中断或更高级中断期间，产生的外部中断源（产生低电平）如果在该中断执行完毕之前撤销（变为高电平）了，那么将得不到响应，就如同没发生一样。同样，当CPU在执行不可被中断的指令（如RETI）时，产生的电平触发中断如果时间太短，也得不到执行。

- 2) 边沿触发方式时，中断标志寄存器锁存了中断请求。

  - 中断口线上一个从高到低的跳变将记录在标志寄存器中，直到CPU响应并转向该中断服务程序时，由硬件自动清除。因此当CPU正在执行同级中断（甚至是外部中断本身）或高级中断时，产生的外部中断（负跳变）同样将被记录在中断标志寄存器中。在该中断退出后，将被响应执行。如果你不希望这样，必须在中断退出之前，手工清除外部中断标志。

- 3) 中断标志可以手工清除。

  - 一个中断如果在没有得到响应之前就已经被手工清除，则该中断将被CPU忽略。就如同没有发生一样。

- 4) 选择电平触发还是边沿触发方式应从系统使用外部中断的目的上去考虑，而不是如许多资料上说的根据中断源信号的特性来取舍。

## 四、外部中断的实验程序
### 1.电平触发方式

```C
/*
 *****************************************************************************************
 *	实 验 名 称:外部中断0的应用
 *  实 验 平 台：清翔电子 QX-MCS51开发板
 *	创 建 作 者：miki
 *  功 能 说 明：测试外部中断低电平触发方式的效果,主函数里数码管循环显示0-9，
 *				 当外部中断0低电平触发时（P3^2），进入中断服务函数让LED以500ms闪烁
 *  github 地 址：
 *	创 建 日 期：2017-11-14
 *****************************************************************************************
 */

/************************************* 包含头文件 ***************************************/
#include <reg52.h>
#include <intrins.h>

/**************************************** 宏定义 *****************************************/
#define uint unsigned int 
#define uchar unsigned char

//typedef unsigned int uint;
//typedef unsigned char uchar;

/*************************************** IO口定义 ****************************************/
sbit DULA_IO = P2^6;
sbit WELA_IO = P2^7;

/************************************* 全局变量定义 **************************************/
uchar GlobalWeiNum = 0x00; 	/* 位选，选择要显示的位 */
uchar code GlobalDisplayTable[] = 
	{0x3f,0x06,0x5b,0x4f,0x66,
	 0x6d,0x7d,0x07,0x7f,0x6f};	/* 段选，选择要显示的数字 */

/*************************************** 函数声明 ****************************************/
void delayMs(uint xms);
void externalInterrupt0Init(void);

/*
 *****************************************************************************************
 * 函数名称：main
 * 函数功能：主函数，整个程序入口
 * 输入参数：无
 * 输出参数：无
 * 其他说明：无
 ******************************************************************************************
 */
void main(void)
{
	uchar num;
    externalInterrupt0Init();
	
    while (1)
    {
        for (num=0;num<10;num++)
        {
	      	DULA_IO = 1;
			P0 = GlobalDisplayTable[num];
			DULA_IO = 0;
	
			P0 = 0xff;
			WELA_IO = 1;
	
			P0 = 0x00;
			WELA_IO = 0;

			P1 = 0xff;

			delayMs(1000);
        }
    }
}

/*
 *****************************************************************************************
 * 函数名称：externalInterrupt0Handler
 * 函数功能：外部中断0中断服务函数
 * 输入参数：无
 * 输出参数：无
 * 其他说明：无
 ******************************************************************************************
 */
void externalInterrupt0Handler(void) interrupt 0
{
    P1 = 0xff;
    delayMs(500);
    P1 = 0x00;
    delayMs(500); 
}

/*
 *****************************************************************************************
 * 函数名称：delayMs
 * 函数功能：实现毫秒级的延时
 * 输入参数：xms：需要延时时间
 * 输出参数：无
 * 其他说明：无
 ******************************************************************************************
 */
void delayMs(uint xms)
{
    uint x,y;
    for (x=xms;x>0;x--)
        for (y=114;y>0;y--);
}

/*
 *****************************************************************************************
 * 函数名称：externalInterrupt0Init
 * 函数功能：外部中断0中断初始化
 * 输入参数：无
 * 输出参数：无
 * 其他说明：无
 ******************************************************************************************
 */
void externalInterrupt0Init(void)
{
    EX0 = 1;   // 开启外部中断 0 ,P3.2选通
    IT0 = 0;   // 设置成电平触发（低电平）
    EA = 1;    // 开启总中断
}

```

### 2.下降沿触发方式
> 与电平触发程序相同，板子硬件连接不同而已。


